# README

## HMM_model_MSA

This repository contains all files and scripts necessary for constructing a profile Hidden Markov Model (HMM) based on 3D structural alignments for the Kunitz-type protease inhibitor domain. The repository is organized into several folders, each serving a specific purpose in the model building and validation process.

## Folder Structure

- **Scripts**: Contains all scripts required to run the program.
- **Performance**: Stores output files and visualizations from the 5-fold cross-validation (CV) performed.
- **Validation**: Holds intermediate files that are outputs of the 5-fold CV and are necessary to generate the plots and results found in the performance folder.
- **Sequences**: Includes the initial datasets of proteins from the Protein Data Bank (PDB) and the output files from multiple sequence alignment and HMM construction.

## Folder Details

### Scripts
This folder includes all necessary scripts to preprocess data, perform 3D structural alignments, build the HMM model, and validate the results. Key scripts include:

- `cross_val.sh`: bash script to run the 5-fold CV.
- `script.sh`: bash script needed to modify the output file of MSA from MUSCLE in order to clean it, removing any white lines and gaps, so to use the final modified file for building the model.
- `select_fasta.py`: the script reads a sequence file in FASTA format and extracts sequences based on a list of identifiers provided in another file.
- `Performance.py`: this script reads predictions from a file, computes performance metrics such as the confusion matrix, overall accuracy (Q2), Matthews Correlation Coefficient (MCC), and F1 score, and then outputs these metrics.
  To run:
   ```sh
     python3 Performance.py predictions.txt 0.01
   ``` 
- `best_mcc.py`: it reads a performance evaluation file, extracts Matthews Correlation Coefficient (MCC) values and their corresponding thresholds, identifies the best threshold that maximizes the MCC, and plots the MCC values against the thresholds.
  To run:
   ```sh
     python3 best_mcc.py performance.txt output_image.png
   ```

### Performance
This folder contains the final output files and visualizations from the 5-fold cross-validation. It includes:

- `msa_com_set_0123.png`, `msa_com_set_0124.png`, `msa_com_set_0134.png`, `msa_com_set_0234.png`, `msa_com_set_1234.png`: graphs generated by the `best_mcc.py` script, plotting e-value thresholds against the corresponding MCC values. 
- `msa_com_set_0123.res`, `msa_com_set_0124.res`, `msa_com_set_0134.res`, `msa_com_set_0234.res`, `msa_com_set_1234.res`: file output of the testing with the 5-fold cross validation and input for the `best_mcc.py` script.
     General structure of the file:
  	```sh
         > threshold_value
         TP=..., TN=..., FN=..., FP=..., Q2=..., MCC=...
         > threshold_value
         TP=..., TN=..., FN=..., FP=..., Q2=..., MCC=...
         ```
- `msa_out_best.txt`: file containing for each validation set, the optimal threshold, the number of TP, TN, FP, FN, the metric values of accuracy, MCC and F1-score.

### Validation
This folder stores intermediate files generated during the 5-fold CV process. These files are essential for building the plots and results in the performance folder. Key files include:

- `msa_set_0.txt`, `msa_set_1.txt`, `msa_set_2.txt`, `msa_set_3.txt`, `msa_set_4.txt`: input files for the application of the `Performance.py` script for the validation sets. 
- `msa_com_set_0123.txt`, `msa_com_set_0124.txt`, `msa_com_set_0134.txt`, `msa_com_set_0234.txt`, `msa_com_set_1234.txt`: input files for the application of the `Performance.py` script for the combined testing sets. 

All files have a similar general structure:
   *seqID e-value label*



### Sequences
This folder contains the initial datasets and processed files necessary for building the HMM model. It includes:

- `rcsb_pdb_custom_report_20240414163443.csv`: this file is a custom report generated from an advanced search in the Protein Data Bank (PDB). It contains information on the 21 selected proteins that were used in the study. The columns included in this file are:
   - PDB ID: The unique identifier for each protein structure in the PDB.
   - Amino Acid Sequence: The sequence of amino acids for the protein.
   - Chain Identifier (Auth Asym ID): The identifier for the specific chain of the protein.
   - Polymer Entity Entry ID: The identifier for the polymer entity within the PDB entry.
- `pdb_seq.ids`: the file is generated from the rcsb_pdb_custom_report_20240414163443.csv file using a series of command-line operations. It contains identifiers for the protein sequences used in the study. It is uploaded in PDBeFold to carry out the 3D structural alignment.
- `clean_msa_kunitz.aln-clustalw`: output of the MSA performed with MUSCLE.
- `cut_msa_kunitz.aln-clustalw`: clean version of the MSA with gaps removed. Input file of the hmmbuild command.
- `cut_msa_kunitz.hmm`: the constructed HMM for the Kunitz-type protease inhibitor domain.
  

## Usage

1. **Run the preprocessing script**:
   ```sh
   cat  rcsb_pdb_custom_report_20240414163443.csv | tr -d '"' |tail -n +3|awk -F "," '{if ($1!="") {print ">"$5"_"$3"\n"$2}}' > pdb_seq.fasta 

   cat  rcsb_pdb_custom_report_20240414163443.csv | tr -d '"' |tail -n +3|awk -F "," '{if ($1!="") {print $5":"$3}}' > pdb_seq.ids 

   tail -n +4 21_msa_kunitz.aln-clustalw > clean_msa_kunitz.aln-clustalw  # remove the header and the white lines 
   
	./script.sh

   head -n 42 final_msa_kunitz.aln-clustalw > msa_kunitz.aln-clustalw # remove last 2 lines that are white

   awk '{if (substr($0,1,1)==">"){print $0} else {print toupper(substr($0,19,60))}}' msa_kunitz.aln-clustalw > cut_msa_kunitz.aln-clustalw

   hmmbuild cut_msa_kunitz.hmm cut_msa_kunitz.aln-clustalw

   cat  rcsb_pdb_custom_report_20240414163443.csv | tr -d '"' |tail -n +3|awk -F "," '{if ($1!="") {print ">"$5"_"$3; print $2}}' > pdb_bpti.fasta

   /makeblastdb -in pdb_bpti.fasta -dbtype prot

   ../../../../../databases_blast/ncbi-blast-2.15.0+/bin/blastp -query all_bpti.fasta -db pdb_bpti.fasta -out al  -outfmt 7 &

   grep -v "^#" all_bpti.blast | awk '{if ($3>95 && $4>50) print $0}'|cut -f 1 | sort -u > tobe_removed.ids.1

   grep ">" all_bpti.fasta | cut -d " " -f 1 | tr -d ">" | sort > all.ids

   comm -23 all.ids tobe_removed.ids | cut -d  "|" -f2 > selected_ids
   
   python3 select_fasta.py selected_ids all_bpti.fasta > bpti_pos_selected.fasta

   ```

1. **Run the 5-fold CV**:
   ```sh
   ./cross_val.sh
   ```
